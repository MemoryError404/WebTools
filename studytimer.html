<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>學習計時器</title>
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      flex-direction: column;
      padding-left: 50px; /* For sidebar */
    }
    #timer { font-size: 4em; margin: 0.5em 0; }
    .buttons { display: flex; gap: 1em; margin-bottom: 1em; }
    button {
      font-size: 1em;
      padding: 0.5em 1em;
      cursor: pointer;
      border: none;
      background-color: #333;
      color: white;
      border-radius: 5px;
    }
    #history {
      margin-top: 20px;
      text-align: left;
      width: 90%;
      max-width: 600px;
      max-height: 200px;
      overflow-y: auto;
      background: #222;
      padding: 10px;
      border-radius: 8px;
    }
  </style>
  <link rel="stylesheet" href="css/home.css">
  <link rel="icon" href="logo.jpg" type="image/x-icon">
</head>
<body>
  <button class="menu-button" onclick="toggleMenu()">☰</button>
  <div class="sidebar" id="sidebar"></div>

  <div id="timer">00:00:00</div>
  <div class="buttons">
    <button id="toggleBtn">開始</button>
    <button id="resetBtn">重設</button>
    <button id="clearHistoryBtn">清除歷史</button>
  </div>
  <div id="history"></div>

  <script>
    let startTime = null;
    let elapsedBeforePause = 0;
    let isRunning = false;
    let timerInterval;

    const timerDisplay = document.getElementById('timer');
    const historyDiv = document.getElementById('history');
    const toggleBtn = document.getElementById('toggleBtn');

    function loadHistory() {
      let history = JSON.parse(localStorage.getItem('timerHistory')) || [];
      const twoDaysAgo = Date.now() - 2 * 24 * 60 * 60 * 1000;
      history = history.filter(h => new Date(h.time).getTime() >= twoDaysAgo);
      localStorage.setItem('timerHistory', JSON.stringify(history));
      return history;
    }

    function saveHistory(entry) {
      let history = loadHistory();
      history.unshift(entry);
      localStorage.setItem('timerHistory', JSON.stringify(history));
      renderHistory();
    }

    function renderHistory() {
      let history = loadHistory();
      historyDiv.innerHTML = '<h3>歷史紀錄</h3>' + history.map(h => `<div>[${h.action}] ${h.time}</div>`).join('');
    }

    function formatTime(ms) {
      let totalSeconds = Math.floor(ms / 1000);
      let hours = Math.floor(totalSeconds / 3600);
      let minutes = Math.floor((totalSeconds % 3600) / 60);
      let seconds = totalSeconds % 60;
      return [hours, minutes, seconds].map(v => String(v).padStart(2, '0')).join(':');
    }

    function updateDisplay() {
      if (isRunning) {
        const now = Date.now();
        const elapsed = (now - startTime) + elapsedBeforePause;
        timerDisplay.textContent = formatTime(elapsed);
      }
    }

    function toggleTimer() {
      if (isRunning) { // Pause
        const now = Date.now();
        elapsedBeforePause += (now - startTime);
        isRunning = false;
        clearInterval(timerInterval);
        timerInterval = null;
        toggleBtn.textContent = '繼續';
        saveHistory({ action: '暫停', time: new Date().toLocaleString() });
        localStorage.setItem('studyTimerState', JSON.stringify({ elapsed: elapsedBeforePause }));
      } else { // Start or Resume
        startTime = Date.now();
        isRunning = true;
        const action = elapsedBeforePause > 0 ? '繼續' : '開始';
        saveHistory({ action: action, time: new Date().toLocaleString() });
        toggleBtn.textContent = '暫停';
        if (!timerInterval) {
            timerInterval = setInterval(updateDisplay, 500);
        }
      }
    }

    function resetTimer() {
      clearInterval(timerInterval);
      timerInterval = null;
      startTime = null;
      elapsedBeforePause = 0;
      isRunning = false;
      timerDisplay.textContent = formatTime(0);
      toggleBtn.textContent = '開始';
      saveHistory({ action: '重設', time: new Date().toLocaleString() });
      localStorage.removeItem('studyTimerState');
    }

    function clearHistory() {
      localStorage.removeItem('timerHistory');
      renderHistory();
    }
    
    function setupSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.innerHTML = `
            <a href="index.html"><h2>WebTools</h2></a>
            <a href="clock.html">Clock</a>
            <a href="timer.html">Timer</a>
            <a href="math.html">Math</a>
            <a href="studytimer.html">Study Timer</a>
        `;
    }

    function init() {
        document.addEventListener('keydown', e => {
            if (e.code === 'Space' && e.target === document.body) {
                e.preventDefault();
                toggleTimer();
            }
        });

        toggleBtn.addEventListener('click', toggleTimer);
        document.getElementById('resetBtn').addEventListener('click', resetTimer);
        document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);

        window.addEventListener('beforeunload', () => {
            if (isRunning) {
                const now = Date.now();
                elapsedBeforePause += (now - startTime);
            }
            if (elapsedBeforePause > 0) {
                localStorage.setItem('studyTimerState', JSON.stringify({ elapsed: elapsedBeforePause }));
            }
        });

        const savedState = JSON.parse(localStorage.getItem('studyTimerState'));
        if (savedState && savedState.elapsed > 0) {
            elapsedBeforePause = savedState.elapsed;
            timerDisplay.textContent = formatTime(elapsedBeforePause);
            toggleBtn.textContent = '繼續';
        } else {
            timerDisplay.textContent = formatTime(0);
        }

        setupSidebar();
        renderHistory();
    }

    init();
  </script>
  <script src="js/sidebar.js"></script>
</body>
</html>
